From 1f7a48de4467f31afc51169122453318efdb0f33 Mon Sep 17 00:00:00 2001
From: MORITA Kazutaka <morita.kazutaka@lab.ntt.co.jp>
Date: Thu, 30 Aug 2012 03:39:45 +0900
Subject: [PATCH] sheepdog: fix savevm and loadvm

This patch sets data to be sent to Sheepdog correctly and fixes savevm
and loadvm operations on a Sheepdog image.

Signed-off-by: MORITA Kazutaka <morita.kazutaka@lab.ntt.co.jp>
Signed-off-by: Kevin Wolf <kwolf@redhat.com>
---
 block/sheepdog.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

Index: new/block/sheepdog.c
===================================================================
--- new.orig/block/sheepdog.c	2012-09-24 07:15:00.000000000 +0200
+++ new/block/sheepdog.c	2012-09-24 07:15:30.000000000 +0200
@@ -1986,7 +1986,7 @@
         vdi_index = pos / SD_DATA_OBJ_SIZE;
         offset = pos % SD_DATA_OBJ_SIZE;
 
-        data_len = MIN(remaining, SD_DATA_OBJ_SIZE);
+        data_len = MIN(remaining, SD_DATA_OBJ_SIZE - offset);
 
         vmstate_oid = vid_to_vmstate_oid(s->inode.vdi_id, vdi_index);
 
@@ -2007,6 +2007,7 @@
         }
 
         pos += data_len;
+        data += data_len;
         remaining -= data_len;
     }
     ret = size;
